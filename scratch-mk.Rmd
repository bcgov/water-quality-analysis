---
title: "R Notebook"
output: html_notebook
---

```{r setup}
library(canwqdata)
library(dplyr)
library(tidyr)
library(ggplot2)
library(lubridate)
library(wqbc)
library(readr)
library(here)
library(feather)
library(purrr)
source(here::here("R/functions.R"))
dir.create(here::here("out"))
```

```{r EC-data}
bc_nested <- readRDS(here("tmp/bc_nested.rds"))

```

Create a monthly data frame and subset to one parameter (arsenic):

```{r}
fraser_hope_arsenic <- filter(bc_nested, 
                              SITE_NO == "BC08MF0001",
                              PARAM_SHORT_NAME == "ARSENIC TOTAL") %>% 
  pull(full_monthly) %>% 
  pluck(1)

ggplot(fraser_hope_arsenic, aes(x = Date, y = month_avg)) + 
  geom_point() + 
  geom_line() +
  geom_smooth(method = "lm")
```



Testing out USGS seaken method:
```{r}
library(smwrStats)
library(smwrGraphs)

fraser_hope_arsenic_sk <- seaken(fraser_hope_arsenic$month_avg)
fraser_hope_arsenic_sk
# seriesPlot(fraser_hope_arsenic_sk)

# non-seasonal - to get an intercept estimate. A bit of a hack, but don't know
# a better way
fraser_hope_arsenic_k <- kensen.test(fraser_hope_arsenic$month_avg, 
                                     t = as.numeric(fraser_hope_arsenic$Date)
)

slope <- fraser_hope_arsenic_sk$estimate["slope"] / 365

int <- fraser_hope_arsenic_k$coef[1] - 
  (slope * min(as.numeric(fraser_hope_arsenic$Date)))

ggplot(fraser_hope_arsenic, aes(x = Date, y = month_avg)) + 
  geom_point() + 
  geom_abline(slope = slope, intercept = int)

```


EnvStats:

```{r}
library(EnvStats)

ks_fraser <- kendallSeasonalTrendTest(month_avg ~ month + year, 
                                      data = fraser_hope_arsenic)

ks_fraser
# In order to account for serial autocorrelation there must be the same number
# of observations in each year (12) - could either pad start and end years 
# with NAs or truncate.
```

Plot the Seasonal Kendall results: need to rescale the slope and intercept 
because they are based on time starting at time zero, and in units/year.
The date scale starts at `as.numeric(min(fraser_hope_arsenic$Date))` and increments by one per day

```{r}
slope <- ks_fraser$estimate["slope"] / 365
# The overall intercept is the median of all seasonal intercepts... doesn't seem
# right
int <- ks_fraser$estimate["intercept"] - 
  (slope * min(as.numeric(fraser_hope_arsenic$Date)))

k_fraser <- kendallTrendTest(fraser_hope_arsenic$month_avg, 
                             as.numeric(fraser_hope_arsenic$Date))

int <- k_fraser$estimate["intercept"] - 
  (slope * min(as.numeric(fraser_hope_arsenic$Date)))
  

ggplot(fraser_hope_arsenic, aes(x = Date, y = month_avg)) + 
  geom_point() + 
  geom_abline(slope = slope, 
              intercept = int)

# plotting on a sequence scale (as the MK test is done on) produces the same 
# figure, so I think I am transforming the slope and intercept correctly.
plot(fraser_hope_arsenic$month_avg ~ seq_len(nrow(fraser_hope_arsenic)))
abline(ks_fraser$estimate["intercept"], ks_fraser$estimate["slope"])

```

```{r}

bc_nested <- mutate(
  bc_nested, 
  sk = map(full_monthly, ~ {
    seaken(.x$month_avg, 12)
  }), 
  p_val = map_dbl(sk, "p.value"), 
  sig = p_val < 0.05,
  slope = map_dbl(sk, list("estimate", "slope")), 
  intercept = map_dbl(sk, list("estimate", "median.data")) - 
                        (map_dbl(sk, list("estimate", "median.time")) * slope), 
  smk_plot = pmap(
   list(d = full_monthly, m = sk, s = SITE_NO, 
        v = PARAM_SHORT_NAME), function(d, m, s, v) {
          plot_smk(d, m, "month_avg", "Date") + 
            labs(title = paste(s, v, sep = ": "), 
                 x = "Date", y = "Value")
           
         })
)
```

```{r eval=FALSE}
pwalk(list(p = bc_nested$smk_plot, s = bc_nested$SITE_NO, 
          v = bc_nested$PARAM_SHORT_NAME), 
     function(p, s, v) {
       safely(ggsave, 
              otherwise = cat(paste0(s, "-", v, "\n"), 
                              file = "log.txt", append = TRUE)
              )(filename = paste0(s, "-", v, ".png"), 
                      plot = p)
     })
```

```{r}
station_results <- bc_nested %>%
  select(SITE_NO, PARAM_SHORT_NAME, sk, p_val, sig, slope, intercept) %>% 
  nest(-SITE_NO, .key = "results")

dummy <- station_results %>% 
  filter(SITE_NO == "AK08DC0001") %>% 
  unnest()

bc_nested %>% filter(SITE_NO == "AK08DC0001") %>% 
  select(SITE_NO, PARAM_SHORT_NAME, full_monthly) %>% 
  unnest() %>% 
  ggplot(aes(x = Date, y = month_avg)) + 
  # geom_step(aes(y = detection_limit)) + 
  geom_point(size = 0.5, aes(colour = censored)) + 
  geom_abline(data = dummy, aes(slope = slope / 365, 
                                intercept = intercept -
    ((slope / 365) * min(as.numeric(as.Date("2004-01-15")))), 
    linetype = sig)) +
  # geom_text(data = dummy, aes())
  facet_wrap(vars(PARAM_SHORT_NAME), scales = "free_y", 
             labeller = label_wrap_gen(width = 15)) + 
  theme_minimal(base_size = 9) + 
  theme(strip.text = element_text(size = 6))
  
for (s in station_results$SITE_NO) {
  dummy <- station_results %>% 
    filter(SITE_NO == s) %>% 
    unnest()
  
  bc_nested %>% filter(SITE_NO == s) %>% 
    select(SITE_NO, PARAM_SHORT_NAME, full_monthly) %>% 
    unnest() %>% 
    ggplot(aes(x = Date, y = month_avg)) + 
    # geom_step(aes(y = detection_limit)) + 
    geom_point(size = 0.5, aes(colour = censored)) + 
    geom_abline(data = dummy, 
                aes(slope = slope / 365, 
                    intercept = intercept -
                      ((slope / 365) * min(as.numeric(as.Date("2004-01-15")))), 
                    linetype = sig)) +
    # geom_text(data = dummy, aes())
    facet_wrap(vars(PARAM_SHORT_NAME), scales = "free_y", 
               labeller = label_wrap_gen(width = 15)) + 
    theme_minimal(base_size = 9) + 
    theme(strip.text = element_text(size = 6)) + 
    labs(x = "Date", y = "Value", linetype = "Significance", 
         title = s, colour = "Censored")
  
  ggsave(file.path(here("out"), paste0("smk-", s, ".pdf")), 
         width = 10, height = 8, units = "in")
  
}
```


Test usgs `restrend` Package for working with censored data.
```{r}
# install.packages("restrend", repos = 'https://owi.usgs.gov/R')
library(restrend)
library(smwrQW)

test_data <- filter(bc_nested, SITE_NO == "BC08FC0001", PARAM_SHORT_NAME == "LEAD TOTAL") %>% 
  select(full_monthly) %>% 
  unnest() %>% 
  arrange(Date)

test_cens <- as.lcens(test_data$month_avg, test_data$detection_limit, test_data$censored)

censSeaken(test_cens)

seaken(test_data$month_avg)
```

