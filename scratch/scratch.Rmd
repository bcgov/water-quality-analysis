---
title: "Trend Exploration"
output: html_notebook
---

```{r EC-data}
library(canwqdata)
library(dplyr)
library(ggplot2)
library(lubridate)
library(wqbc)
library(mgcv)
library(broom)

fraser <- wq_basin_data("fraser")

fraser_tidy <- tidy_ec_data(fraser)
fraser_tidy$id <- seq_len(nrow(fraser_tidy))

foo <- add_shortnames(fraser_tidy)

# Try a trend test with Fraser River at Hope
fraser_hope_arsenic <- filter(foo, SITE_NO == "BC08MF0001", !is.na(PARAM_SHORT_NAME)) %>% 
  group_by(PARAM_SHORT_NAME, DateTime, Units, ResultLetter, DetectionLimit) %>% 
  summarise(avg_val = mean(Value, na.rm = TRUE), 
            n = n()) %>% 
  filter(PARAM_SHORT_NAME == "ARSENIC TOTAL") %>% 
  ungroup()


fraser_hope_arsenic <- fraser_hope_arsenic %>% 
  mutate(month = month(DateTime, label = FALSE), 
         year = year(DateTime)) %>% 
  filter(year >= 2003) %>% 
  group_by(PARAM_SHORT_NAME, month, year) %>% 
  summarise(month_avg = mean(avg_val, na.rm = TRUE)) %>% 
  mutate(Date = as.Date(paste(year, month, "15", sep = "-")), 
         Time = as.numeric(Date) / 1000) %>% 
  arrange(Date) %>% 
  ungroup() %>% 
  as.data.frame()

ggplot(fraser_hope_arsenic, aes(x = Date, y = month_avg)) + 
  geom_point()

# Make it into a complete time series:
month_df <- data.frame(Date = seq(min(fraser_hope_arsenic$Date), 
                                  max(fraser_hope_arsenic$Date), 
                                  by = "month"))

fraser_hope_arsenic <- right_join(fraser_hope_arsenic, month_df)

fraser_arsenic_gam <- mgcv::gam(month_avg ~ s(month, bs = "cc", k = 12) + 
                                  s(Time, k = 20),
                                data = fraser_hope_arsenic, 
                                method = "REML")

plot(fraser_arsenic_gam)
summary(fraser_arsenic_gam$gam)

fraser_arsenic_gam_aug <- broom::augment(fraser_arsenic_gam$gam)

ggplot(fraser_arsenic_gam_aug, aes(x = Time, y = month_avg)) + 
  geom_point() + 
  geom_line(aes(y = .fitted))

summary(fraser_arsenic_gam)

```


```{r}
library(rems)
library(dplyr)
library(ggplot2)
library(lubridate)
library(wqbc)

two_year <- get_ems_data(ask = FALSE, dont_update = TRUE)

two_year_tidy <- tidy_ems_data(two_year)

bar <- add_shortnames(two_year_tidy)

```

